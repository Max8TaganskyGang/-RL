# Task 4: Векторизация среды

## Описание

Реализация векторизованных версий среды GridWorld для ускорения обучения. Поддерживается два типа векторизации:

1. **Наивная векторизация (SyncVectorEnv)** - обертка над несколькими независимыми средами
2. **Полноценная векторизация (numpy)** - настоящая параллельная обработка всех сред в batch-режиме

## Структура

```
task4/
├── vectorized_wrapper.py      # Наивная векторизация (SyncVectorEnv)
├── vectorized_gridworld.py    # Полноценная векторизация (numpy)
├── train_vectorized.py        # Training pipeline для векторизованных сред
├── run_comparison.py          # Скрипт для сравнения методов
├── results/                   # Результаты экспериментов
└── videos/                    # Видео траекторий (опционально)
```

## Реализация

### 1. Наивная векторизация (`vectorized_wrapper.py`)

Использует `SyncVectorEnv` из gymnasium для создания обертки над несколькими независимыми средами. Это **не полноценная векторизация** - среды выполняются последовательно, но API унифицирован для batch-обработки.

### 2. Полноценная векторизация (`vectorized_gridworld.py`)

Реализует `VectorizedGridWorldEnv` - полноценную векторизованную среду, где все вычисления выполняются параллельно с использованием numpy:

- Все состояния, действия и переходы обрабатываются в batch-режиме
- Проверки столкновений, вычисления наград - все векторизовано
- Настоящее ускорение за счет параллельной обработки всех сред одновременно

### 3. Training Pipeline (`train_vectorized.py`)

Адаптированный training pipeline для работы с векторизованными средами:

- Поддержка как `SyncVectorEnv`, так и `VectorizedGridWorldEnv`
- Правильная обработка завершенных эпизодов
- Batch-обработка переходов для обучения
- Логирование метрик с учетом общего количества шагов по всем средам

### 4. Сравнение (`run_comparison.py`)

Скрипт для сравнения обычной и векторизованных сред:

- Запускает обучение на всех трех типах сред
- Сравнивает скорость обучения (шагов в секунду)
- Сравнивает качество обучения (финальная награда)
- Выводит таблицу с результатами сравнения

## Использование

### Запуск сравнения

```bash
python task4/run_comparison.py --env 1 --num-envs 4 --episodes 500 --wandb --wandb-project RL4
```

Параметры:
- `--env`: ID окружения (1, 2, или 3)
- `--num-envs`: Количество параллельных сред
- `--episodes`: Количество эпизодов для обучения (суммарно по всем средам)
- `--wandb`: Использовать Wandb для логирования
- `--wandb-project`: Название проекта в Wandb

### Пример использования в коде

```python
from task4.vectorized_wrapper import make_vectorized_env
from task4.vectorized_gridworld import VectorizedGridWorldEnv

# Наивная векторизация
env_sync = make_vectorized_env(num_envs=4, grid_size=5, ...)

# Полноценная векторизация
env_vectorized = VectorizedGridWorldEnv(num_envs=4, grid_size=5, ...)

# Использование одинаковое для обоих типов
obs, info = env.reset()  # obs shape: (num_envs, obs_shape)
obs, rewards, terminated, truncated, info = env.step(actions)  # actions shape: (num_envs,)
```

## Результаты

После запуска сравнения результаты сохраняются в `task4/results/comparison_env{env_id}.pkl` и содержат:

- Метрики обучения для всех трех методов
- Время обучения
- Общее количество шагов
- Скорость (шагов в секунду)
- Финальная награда

## Заметки

- **Общее количество шагов**: При сравнении графиков обучения используется общее число шагов (сумма по всем параллельным средам), а не количество эпизодов
- **Сброс сред**: В векторизованных средах завершенные эпизоды обрабатываются автоматически, сброс происходит только для завершенных сред
- **Качество обучения**: Все методы должны показать одинаковое качество обучения при одинаковых условиях, разница только в скорости

